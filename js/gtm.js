'use strict'
function GTMUA(){this.init();}GTMUA.prototype={homePage:'Homepage',categoryPage:'Category',subCategoryPage:'Sub Category',searchPage:'Search Result',detailRelevantPage:'Detail - Course Relevant',cartPage:'Cart Page',checkoutPage:'Checkout Page',purchasePage:'Purchase Page',otherPage:'Other Page',init:function(){var that=this;that.initGTMDataLayer();},initGTMProductClick:function(page){var that=this;switch(page){case that.homePage:var $container=$('#k-highlights');$container.find('>ul>li>a, >ul>li .img>.background-detail>span a').click(function(){var $parent=$(this).closest('li');var productObj={'name':$parent.find('>div.k-box-card-wrap>div.content h4').text(),'id':$parent.find('> div.k-box-card-wrap').attr('data-id'),'price':that.deCurrency($parent.find('>div.k-box-card-wrap>div.view-price .price > strong').text()),'brand':$parent.find('>div.k-box-card-wrap>div.content span.author').text(),'cat':'Khóa học nổi bật','position':$parent.index()+1};that.insertDataProductClick(productObj,page);});break;case that.categoryPage:case that.subCategoryPage:case that.searchPage:var $container=$('#k-listing');var category=$('ul.breadcrumb > li').last().text();if($('ul.breadcrumb > li').last().find('>span').length>0){category=$('ul.breadcrumb > li').last().find('>span').text();}$container.find('ul.k-box-card-list>li>a, ul.k-box-card-list>li .img>.background-detail>span a').click(function(){var $parent=$(this).closest('li');var productObj={'name':$parent.find('>div.k-box-card-wrap>div.content h4').text(),'id':$parent.find('> div.k-box-card-wrap').attr('data-id'),'price':that.deCurrency($parent.find('>div.k-box-card-wrap>div.view-price .price > strong').text()),'brand':$parent.find('>div.k-box-card-wrap>div.content span.author').text(),'cat':category,'position':$parent.index()+1};that.insertDataProductClick(productObj,page);});break;case that.detailRelevantPage:var $container=$('.k-course-details-related');var category=$('ul.breadcrumb > li').last().text();if($('ul.breadcrumb > li').last().find('>span').length>0){category=$('ul.breadcrumb > li').last().find('>span').text();}$container.find('ul.k-course-details-related-list').find('>li>div.k-related-courses-text>h6>a').click(function(e){e.preventDefault();var $parent=$(this).closest('li');var productObj={'name':$parent.find('>div.k-related-courses-text>h6>a').text(),'id':$parent.attr('data-id'),'price':that.deCurrency($parent.find('>div.k-related-courses-text>ul>li:first>span').text()),'brand':$parent.attr('data-brand'),'cat':category,'position':$parent.index()+1};that.insertDataProductClick(productObj,page);window.location.href=$(this).attr('href');});break;default:break;}},initGTMImpression:function(page){var that=this;var productImpressions=[];switch(page){case that.homePage:var $container=$('#k-highlights');$container.find('>ul').find('>li').each(function(index){productImpressions.push({'name':$(this).find('>div.k-box-card-wrap>div.content h4').text(),'id':$(this).find('> div.k-box-card-wrap').attr('data-id'),'price':that.deCurrency($(this).find('>div.k-box-card-wrap>div.view-price .price > strong').text()),'brand':$(this).find('>div.k-box-card-wrap>div.content span.author').text(),'category':'Khóa học nổi bật','variant':'','list':page,'position':index+1});});break;case that.categoryPage:case that.subCategoryPage:case that.searchPage:var $container=$('#k-listing');var category=$('ul.breadcrumb > li').last().text();if($('ul.breadcrumb > li').last().find('>span').length>0){category=$('ul.breadcrumb > li').last().find('>span').text();}$container.find('ul.k-box-card-list').find('>li').each(function(index){productImpressions.push({'name':$(this).find('>div.k-box-card-wrap>div.content h4').text(),'id':$(this).find('> div.k-box-card-wrap').attr('data-id'),'price':that.deCurrency($(this).find('>div.k-box-card-wrap>div.view-price .price > strong').text()),'brand':$(this).find('>div.k-box-card-wrap>div.content span.author').text(),'category':category,'variant':'','list':page,'position':index+1});});break;case that.detailRelevantPage:var $container=$('.k-course-details-related');var category=$('ul.breadcrumb > li').last().prev().find('>a>span').text();$container.find('ul.k-course-details-related-list').find('>li').each(function(index){productImpressions.push({'name':$(this).find('div.k-related-courses-text>h6>a').text(),'id':$(this).attr('data-id'),'price':that.deCurrency($(this).find('div.k-related-courses-text>ul>li:first>span').text()),'brand':$(this).attr('data-brand'),'category':category,'variant':'','list':page,'position':index+1});});break;default:break;}that.insertDataImpression(productImpressions);},initDetailImpression:function(page){var that=this;var productObj=null;switch(page){case that.detailRelevantPage:var $container=($('.k-course-details-header').length>0)?$('.k-course-details-header'):$('.k-combo-details-header');var category=$('ul.breadcrumb > li').last().prev().find('>a>span').text();var name=$('ul.breadcrumb > li').last().find('>span').text();var brand=$container.find('.k-course-details-title > a').first().text();var price=$container.find('.price-list>ul>li:first>span span').text();var id=$('.k-course-details-header, .k-combo-details-header').attr('data-id');productObj={'name':name,'id':id,'price':that.deCurrency(price),'brand':brand,'cat':category};break;default:break;}that.insertDataDetailImpression(productObj);},initFbViewContent:function(page){var that=this;var productObj=null;switch(page){case that.detailRelevantPage:var $container=$('.k-course-details-header, .k-combo-details-header');var category=$('ul.breadcrumb > li').last().prev().find('>a>span').text();;productObj={'name':$('.k-course-details-title > h1, .k-combo-title-md > h1').first().text(),'id':$('.k-course-details-header, .k-combo-details-header').attr('data-id'),'price':that.deCurrency($container.find('.price-list>ul>li:first').text()),'brand':$container.find('.k-course-details-title > a').text(),'cat':category};break;default:break;}that.insertDataFbViewContent(productObj);},initAddToCart:function(page){var that=this;switch(page){case that.homePage:case that.searchPage:var $container=$('.k-popup-lesson');var category='Khóa học nổi bật';$('body').on('click','.add-to-cart',function(e){var productObj={'name':$container.find('.modal-header>h4').text(),'id':$container.find('.modal-body').attr('data-id'),'price':that.deCurrency($container.find('ul.k-popup-lesson-detail-price>li:first>span.bold').text()),'brand':$container.find('.modal-body').attr('data-brand'),'cat':category,'quantity':1};that.insertDataAddToCart(productObj);});break;case that.detailRelevantPage:var $container=($('.k-course-details-header').length)?$('.k-course-details-header'):$('.k-combo-details-header');var category=$('ul.breadcrumb > li').last().prev().find('>a>span').text();$container.find('.add-to-cart').click(function(){var productObj={'name':($('.k-combo-title-md > h1').text()!="")?$('.k-combo-title-md > h1').text():$('.k-course-details-title > h1').text(),'id':$('.k-course-details-header, .k-combo-details-header').attr('data-id'),'price':that.deCurrency($('.price-list > ul > li:first > span span').text()),'brand':$container.find('.k-course-details-title > a').text(),'cat':category,'quantity':1};that.insertDataAddToCart(productObj);});break;default:break;}},initRemoveFromCart:function(page){var that=this;switch(page){case that.cartPage:var $container=$('.k-shopping-list-items');var category='';$container.find('a.cart-item-remove').click(function(){var $parent=$(this).closest('li.items');var productObj={'name':$parent.find('>div.k-shopping-list-items-title>div.items-text>h4>a').text(),'id':$parent.find('>div.k-shopping-list-items-title').href('data-id'),'price':that.deCurrency($parent.find('>div.k-shopping-list-items-price>span.sale').text()),'brand':$parent.find('>div.k-shopping-list-items-title').href('data-brand'),'cat':category};that.insertDataRemoveFromCart(productObj);});break;default:break;}},initCheckout:function(page){var that=this;switch(page){case that.checkoutPage:var $container=$('#checkout-home');var category='';var productCheckout=[];$container.find('ul.list>li').each(function(index){productCheckout.push({'name':$(this).find('>div.text>h6>a').text(),'id':that.deUrl($(this).find('>div.text>h6>a').attr('href')),'price':that.deCurrency($(this).find('>div.text>span.price').text()),'brand':'','category':category,'position':index+1,'quantity':1});});that.insertDataEventCheckout(productCheckout,2);$container.find('div.wrap-checkout-button-pc .checkout-button').click(function(){that.insertDataEventCheckout(productCheckout,1);});break;default:break;}},initPurchase:function(page){var that=this;switch(page){case that.purchasePage:var $container=$('#checkout-succ-online');if($container.find('.checkout-succ-title').length>0){var category='';var productObj=[];var $checkoutListPrice=$container.find('.checkout-list-price');var actionField={'id':$container.find('.checkout-succ-title .media-body>span>strong').text(),'affiliation':'Kyna.vn','revenue':that.deCurrency($checkoutListPrice.find('>ul>li:last>span.price').text()),'tax':'0','shipping':($checkoutListPrice.find('>ul>li:last>span.shipping-price').length>0)?that.deCurrency($checkoutListPrice.find('>ul>li:last>span.shipping-price').text()):'0','coupon':($container.find('.checkout-banner-confirm>ul>li:last>p').length==6)?$container.find('.checkout-banner-confirm>ul>li:last>p:last').text():''};$container.find('ul.list>li').each(function(index){productObj.push({'name':$(this).find('>div.text>h6>a').text(),'id':that.deUrl($(this).find('>div.text>h6>a').attr('href')),'price':that.deCurrency($(this).find('>div.text>span.price').text()),'brand':'','category':category,'coupon':'','quantity':1});});that.insertDataPurchase(actionField,productObj);}break;default:break;}},initGTMReMarketing:function(page){var that=this;var productImpressions=[];switch(page){case that.homePage:dataLayer.push({'event':'google_tag_params','remarketing_data':{'dynx_pagetype':'home'}});break;case that.categoryPage:case that.subCategoryPage:case that.searchPage:var $container=$('#k-listing');$container.find('ul.k-box-card-list').find('>li').each(function(index){productImpressions.push(that.deUrl($(this).find('>a').attr('href')));});dataLayer.push({'event':'google_tag_params','remarketing_data':{'dynx_itemid':productImpressions,'dynx_pagetype':'searchresults'}});break;case that.detailRelevantPage:var $container=$('.k-course-details-header');dataLayer.push({'event':'google_tag_params','remarketing_data':{'dynx_itemid':window.location.pathname,'dynx_pagetype':'offerdetail','dynx_totalvalue':that.deCurrency($container.find('.price-list>ul>li:first').text())}});break;case that.otherPage:dataLayer.push({'event':'google_tag_params','remarketing_data':{'dynx_pagetype':'other'}});break;default:break;}that.insertDataImpression(productImpressions);},initFbq:function(page){var that=this;switch(page){case that.searchPage:var keyword=$('#k-listing span.menu-heading > h1').text();dataLayer.push({'event':'fbqSearch','search_string':keyword});break;case that.detailRelevantPage:break;case that.purchasePage:var $container=$('#checkout-succ-online');if($container.find('.checkout-succ-title').length>0){var category='';var productObj=[];var $checkoutListPrice=$container.find('.checkout-list-price');var actionField={'id':$container.find('.checkout-succ-title .media-body>span>strong').text(),'affiliation':'Kyna.vn','revenue':that.deCurrency($checkoutListPrice.find('>ul>li:last>span.price').text()),'tax':'0','shipping':($checkoutListPrice.find('>ul>li:last>span.shipping-price').length>0)?that.deCurrency($checkoutListPrice.find('>ul>li:last>span.shipping-price').text()):'0','coupon':($container.find('.checkout-banner-confirm>ul>li:last>p').length==6)?$container.find('.checkout-banner-confirm>ul>li:last>p:last').text():''};dataLayer.push({'event':'fbqPurchase','value':actionField.revenue});}break;default:break;}},insertDataImpression:function(productImpressions){if(productImpressions.length>0){dataLayer.push({'ecommerce':{'impressions':productImpressions}});}},insertDataProductClick:function(productObj,page){dataLayer.push({'event':'productClick','ecommerce':{'click':{'actionField':{'list':page},'products':[{'name':productObj.name,'id':productObj.id,'price':productObj.price,'brand':productObj.brand,'category':productObj.cat,'position':productObj.position}]}}});},insertDataDetailImpression:function(productObj){dataLayer.push({'ecommerce':{'detail':{'actionField':{'list':'Detail'},'products':[{'name':productObj.name,'id':productObj.id,'price':productObj.price,'brand':productObj.brand,'category':productObj.cat}]}}});},insertDataFbViewContent:function(productObj){dataLayer.push({'event':'fbqViewContent','product_id':productObj.id,'product_name':productObj.name,'product_category':productObj.cat,'product_price':productObj.price});},insertDataAddToCart:function(productObj){dataLayer.push({'event':'fbqAddToCart','product_id':productObj.id,'product_name':productObj.name,'product_price':productObj.price});dataLayer.push({'event':'addToCart','ecommerce':{'currencyCode':'VND','add':{'products':[{'name':productObj.name,'id':productObj.id,'price':productObj.price,'brand':productObj.brand,'category':productObj.cat,'quantity':productObj.quantity}]}}});},insertDataRemoveFromCart:function(productObj){dataLayer.push({'event':'removeFromCart','ecommerce':{'remove':{'products':[{'name':productObj.name,'id':productObj.id,'price':productObj.price,'brand':productObj.brand,'category':productObj.cat}]}}});},insertDataEventCheckout:function(productObj,step){dataLayer.push({'event':'checkout','ecommerce':{'checkout':{'actionField':{'step':step},'products':productObj}}});},insertDataPurchase:function(actionField,productObj){dataLayer.push({'ecommerce':{'purchase':{'actionField':actionField,'products':productObj}}});},initGTMDataLayer:function(){var that=this;var pathName=window.location.pathname;var search=window.location.search;var slugPattern=/[a-z0-9-]+/g;var regex=new RegExp(slugPattern);var pageMatch=pathName.match(regex);if(pageMatch===null){that.initGTMImpression(that.homePage);that.initGTMProductClick(that.homePage);that.initAddToCart(that.homePage);that.initGTMReMarketing(that.homePage);}else if(pageMatch.length>0&&pageMatch[0]==="gio-hang"){that.initRemoveFromCart(that.cartPage);that.initGTMReMarketing(that.otherPage);}else if(pageMatch.length>0&&pageMatch[0]==="thanh-toan"&&pageMatch[1]==="thanh-cong"){that.initPurchase(that.purchasePage);that.initGTMReMarketing(that.otherPage);that.initFbq(that.purchasePage);}else if(pageMatch.length>0&&pageMatch[0]==="thanh-toan"){that.initCheckout(that.checkoutPage);that.initGTMReMarketing(that.otherPage);}else if(pageMatch.length>0&&search===""&&$('.k-course-details-related').length>0){that.initGTMImpression(that.detailRelevantPage);that.initGTMProductClick(that.detailRelevantPage);that.initDetailImpression(that.detailRelevantPage);that.initAddToCart(that.detailRelevantPage);that.initGTMReMarketing(that.detailRelevantPage);that.initFbViewContent(that.detailRelevantPage);}else if(pageMatch.length<3&&search===""&&$('#k-listing').length>0){that.initGTMImpression(that.categoryPage);that.initGTMProductClick(that.categoryPage);that.initGTMReMarketing(that.categoryPage);}else if(pageMatch.length>=3&&search===""&&$('#k-listing').length>0){that.initGTMImpression(that.subCategoryPage);that.initGTMProductClick(that.subCategoryPage);that.initGTMReMarketing(that.subCategoryPage);}else if(pageMatch.length>0&&search!==""&&$('#k-listing').length>0){that.initGTMImpression(that.searchPage);that.initGTMProductClick(that.searchPage);that.initGTMReMarketing(that.searchPage);that.initFbq(that.searchPage);that.initAddToCart(that.searchPage);}else{that.initGTMReMarketing(that.otherPage);}},deCurrency:function(originalStr){var str=originalStr.match(/[\d\,\.]+/g);if(str){return str[0].replace(/,/g,'.').replace(/\s/g,'').replace(/\./g,'');}return originalStr;},deUrl:function(str){return str.replace(/\-p[0-9]{1,}.*/g,'');}};